<?php
if(!defined('IN_KKFRAME')) exit();
class HOOK{ function INIT(){ global $_PLUGIN; $_PLUGIN = array(); $_PLUGIN['list'] = CACHE::get('plugins'); $_PLUGIN['obj'] = array(); $_PLUGIN['hook'] = array(); $_PLUGIN['page'] = array(); foreach($_PLUGIN['list'] as $plugin){ $id = $plugin['name']; $classfile = ROOT.'./plugins/'.$id.'/plugin.class.php'; if(file_exists($classfile)){ require_once $classfile; $classname = "plugin_{$id}"; if(!class_exists("plugin_{$id}", false)) continue; $_PLUGIN['obj'][$id] = new $classname(); $methods = get_class_methods($classname); foreach ($methods as $method) $_PLUGIN['hook'][$method][] = $id; if(method_exists($_PLUGIN['obj'][$id], 'getMethods')) $_PLUGIN['obj'][$id]->modules = $_PLUGIN['obj'][$id]->getMethods(); foreach ($_PLUGIN['obj'][$id]->modules as $module) self::parse_module($module, $id); } } } function parse_module($module, $pluginid){ global $_PLUGIN; switch($module['type']){ case 'page': $_PLUGIN['page'][] = array( 'id' => "{$pluginid}-{$module[id]}", 'title' => $module['title'], 'file' => ROOT."./plugins/{$pluginid}/".$module['file'], 'admin' => $module['admin'], ); break; default: throw new Exception('Unknown module type: '.$module['type']); } } function page_menu(){ global $_PLUGIN, $uid; foreach ($_PLUGIN['page'] as $page){ if($page['admin'] && !is_admin($uid)) continue; echo "<li id=\"menu_{$page[id]}\"><a href=\"#{$page[id]}\">{$page[title]}</a></li>"; } } function page_contents(){ global $_PLUGIN, $uid; foreach($_PLUGIN['page'] as $page){ if($page['admin'] && !is_admin($uid)) continue; echo "<div id=\"content-{$page[id]}\" class=\"hidden\">"; @include $page['file']; echo "</div>\r\n"; } } function run($hookname){ global $_PLUGIN; $hooks = $_PLUGIN['hook'][$hookname]; if(!$hooks) return; $args = func_get_args(); foreach($hooks as $pluginid){ try{ echo $_PLUGIN['obj'][$pluginid]->$hookname($args); }catch(Exception $e){ error::exception_error($e); } } } }
